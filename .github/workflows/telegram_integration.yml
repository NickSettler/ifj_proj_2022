name: Telegram Integration
on:
  pull_request_target:
    types: [ assigned, review_requested ]
  pull_request:
    types: [ assigned, review_requested ]
  issues:
    types: [ assigned ]

jobs:
  get_telegram_username:
    runs-on: ubuntu-latest
    steps:
      - name: Get Telegram Username
        id: get_telegram_username
        env:
          TELEGRAM_USERS: ${{ secrets.TELEGRAM_USERS }}
        run: |
          IFS=', ' read -r -a users <<< "$TELEGRAM_USERS"
          target_username="${{ github.event.assignee.login }}"
          for user in "${users[@]}"; do
              IFS=':' read -r -a user <<< "$user"
              if [ "${{ github.event.assignee.login }}" == "${user[0]}" ]; then
                  target_username="${user[1]}"
                  break
              fi
          done
          echo "target_username=$target_username\n" >> $GITHUB_OUTPUT
    outputs:
      target_username: ${{ steps.get_telegram_username.outputs.target_username }}

  send_pr_assigned:
    runs-on: ubuntu-latest
    if: (github.event_name == 'pull_request' && github.event.action == 'assigned')
    needs: get_telegram_username
    steps:
      - name: Send Telegram Message
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: html
          message: |
            ðŸ‘‹ Hi, @${{ needs.get_telegram_username.outputs.target_username }}!

            You have been assigned to <a href="${{ github.event.pull_request.html_url }}">${{ github.event.pull_request.title }}</a> 
            in <a href="${{ github.event.repository.html_url }}">${{ github.repository }}</a>.